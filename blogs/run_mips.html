<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;utf-8">
<title>Sillicon Labs产品经理教你如何以 0 MIPS 运行你的嵌入式系统</title>
</head>
<meta content="MIPS，低功耗" name="keywords">
<meta content="以 0 MIPS 运行你的嵌入式系统" name="description">
<meta http-equiv="expires" content="0">
<meta http-equiv="expires" content="0">
<meta http-equiv="cache-control" content="no-store">
<link rel="stylesheet" href="/css/qrspace.css" type="text/css"/>
<script type="text/javascript" src="/js/jquery.js"></script>
<script type="text/javascript" src="/js/qrspace.js"></script>
<body>
<h3>
    Sillicon Labs产品经理教你如何以 0 MIPS 运行你的嵌入式系统</h3>
<h4>
    作者：ivind Loe，Silicon Labs微控制器产品高级营销经理
</h4> 
<p>
    即使是在诸如物联网应用的无线连接这种主导功耗的事件中，让尽可能多的进程自主运行，也可大大提高电池寿命。降低功耗一直是微控器（MCU）市场的一个主要关注点。超低功耗MCU现在可以大大降低工作模式和深度睡眠模式下的功耗。这种变化的效果是显而易见的，它大大提高了我们日常嵌入式应用中的电池寿命，并且提供了在未来使用能量收集的可能性。
</p>
<p>
    然而，要基于新型 MCU 降低功耗，开发人员必须考虑到许多因素，对此 Silicon Labs 特别撰写一篇技术文章：“以 0 MIPS 运行你的嵌入式系统”，帮助开发人员了解如何利用新型 MCU 中外设的自主运行，通过更接近以 “0” MIPS 运行，来实现数据手册中所承诺的低功耗。
</p>
<h2>低功耗为嵌入式系统研发关键</h2>
<p>
    对于在功耗敏感型物联网（IoT）应用中所使用的新型 MCU 和无线 MCU（WMCU）来说，执行代码时的功耗已经明显下降，甚至达到 40μA/MHz以下。使用这些低功耗规格，您可能会想知道为什么我们需要睡眠模式，为什么不以500 kHz运行您的代码来实现 20μA 的电流消耗，并且允许您的应用使用电池运行 10 年？其实事情并不是这么简单的。
</p>    
<p>
    睡眠模式下的功耗在过去几年中也有显著的改善。我们现在可以看到深度睡眠模式下的功耗低于 2μA，而一些睡眠模式下的功耗甚至低于 50 nA。您可能会觉得拥有这些模式设计出来的系统功耗自然很低，然而事实并非如此，应用能否利用睡眠模式才是关键。
</p>        
<h2>为什么工作模式是好的...也是坏的</h2>
<p>
    使用 MCU 或 WMCU 的最直接的方法是让 CPU 管理一切。例如，您可以启动模数转换（ADC），将一些数据放入通信接口（如 USART 传输）中，读取 ADC 数据，并对数据做出一些处理，所有一切都由 CPU 直接控制。直接的 CPU 控制简化了开发，但其成本是：每当外设或外部事件需要处理时，MCU 都将处于工作模式，从而使功耗大增。
</p>    
<p>
    近期，一些数据手册显示工作模式的电流是 40μA/MHz 甚至更低，它们通常是高时钟频率下的参数，低频下会变大，进而导致绝对功耗变大。这是因为工作模式下频率和功耗不是线性关系。功耗由如下两部分组成，其中第二部分和频率联系不紧密：
</p>
<p><ul>
    <li>1. 处理器本身，它是和频率按比例变化的。</li>   
    <li>2. 有基础工作电流的模块，比如低压差线性稳压器（LDO），欠压检测器（BOD）等。</li>
    </ul>

        要想降低功耗，应尽可能地减少 MCU 在高功耗的工作模式下运行，尽可能地关闭外设，让 CPU 尽可能多地睡眠。
</p>        
        <h2>功耗预算</h2>
<p>        
    对于受限于能源的电池供电型应用来说，要知道能源消耗在哪里才能进行优化。表 1 显示了一个传感器检测无线应用的功耗预算，它的功耗优化不太好。
</p>
<p>
    通过平均计算每个组件的功耗来测量或估计功耗。如果 CPU 占空比为两个百分点，并且在 60μA/MHz时工作在20 MHz，则 CPU 的消耗为 24μA。
</p>
<p>
    请注意，表 1 所示的功耗预算是根据功能划分的。例如，基础睡眠电流包括一个低频振荡器和一个实时时钟（RTC）来对系统事件进行定时从而允许深度睡眠。
</p>
<p>
    传感器测量部分是由一个 0.5kHz 的中断触发，中断之间深度睡眠。低功耗蓝牙每秒钟都要把数据发出去，这是个很普遍的低功耗应用。最后，还有一些非 MCU 部分的功耗。MCU 可能无法直接控制这些模块中的一部分，包括电源管理外设，在这个例子中，MCU是直接控制 ADC 对传感器进行采样，如果不是的话，传感器电流将完全是图片中的数据。
</p>
<p>
    对于这个例子，传感器的持续电流大约是 390μA，但是通过调整占空比，每个 ADC 采样仅仅使用了 10 μs 的时间，从而可以大大降低功耗。
</p>
<p><img src="/pics/blogs/run-mips-0.png"/></p>
<p>表1   目标应用的功耗预算
</p>
<p>
    如果该无线应用由具有 225 mAh 容量的 CR2032 电池供电，则在 61.6μA 功耗下操作时其寿命约为 0.4 年。事实上，我们可以做得更好。
</p>        
<h2>改善现状</h2>
<p>
    我们来看看降低 MCU 传感器测量电流的方法。虽然此示例涉及 ADC 测量外部传感器，但相关示例可能集中在一系列不同类型的测量以及与外部环境的交互上。在这两种情况下，MCU 和外部环境之间都会发生频繁的交互。
</p>
<p>
    实现低功耗传感的最简单的方法是让 CPU 尽可能多地处于睡眠模式，只在采样时唤醒，并尽可能快地重回睡眠模式。对于非常低的采样率来说，这种方法很好，但是从图1可以看出，当每秒采样次数增加时，系统的功耗也会显著增加：
</p>
<p><img src="/pics/blogs/run-mips-1.png"/></p>
<p>图1  采用中断进行 ADC 采样，显示出随着每秒采样次数的增加，功耗也在增加</p>
<p>
    许多类型的应用必须具有频繁的活动，同时还需要保持电池寿命。超过 1kHz 的活动率并不是闻所未闻，这时候就需要采取措施来保持低功耗。
</p>
<p>
    图 2 显示了传感器管理的两种附加方法。外设反射系统/直接存储器访问（PRS / DMA）方法使 CPU 在完全不参与的情况下在深度睡眠模式进行 ADC 采样。而不是 RTC 唤醒 CPU，然后 CPU 启动 ADC 进行采样。RTC 通过事件系统（如Silicon Labs的PRS）将事件直接发送到 ADC。ADC 在接收到此事件时自动启动 ADC 转换。转换完成后，DMA 在这种情况下也能够从深度睡眠模式下运行，从 ADC 获取数据并将其存储在 RAM 中。 PRS / DMA 方法的好处是显著降低了电流消耗。在 1 kHz 时，系统电流从 58μA 降低到 25μA。
</p>
<p><img src="/pics/blogs/run-mips-2.png"/></p>
<p>图2  该 ADC 采样图显示了各种工作方式下的功耗</p>
<p>
    驱动 ADC 的更有效的方法是 PRS /比较器（CMP）方法，其中 RTC 仍然通过 PRS 系统触发 ADC，但在这种情况下，ADC 立即使用比较功能对样本进行评估，除非发现有需要的数据，否则不使用 DMA 或 CPU。这种方法能够实现 1 kHz 采样率时系统电流只有 3.5μA。
</p>        
<h2>动态 ADC 比较器</h2>
<p>
    使用 PRS/CMP 方法，大部分采样数据都被丢弃，CPU 只关注需要处理的数据。当信号变化缓慢时，或者需要特定的信号时，这种方法很有效。
</p>
<p>
    当使用比较功能监视信号时，一种方法是测量信号，然后根据这个信号设置阈值，只要信号在阈值范围内，那么当ADC 测量信号时，系统可以保持在深度睡眠模式，当然 CPU 也保持在睡眠模式。
</p>
<p>
    然而，如果信号发生变化，并且超过阈值，系统将知道该信号，并采取适当的措施。在回到睡眠模式之前，ADC 阈值将重新配置以适应新的信号值，因此系统可以再次进入睡眠模式，直到下一次信号发生变化。图 3 显示了这种技术的示例。圆点表示 ADC 样本，箭头表示每当 CPU 被唤醒时，它将记录本次变化并重新配置阈值。
</p>        
        
<p><img src="/pics/blogs/run-mips-3.png"/></p>        
<p>图 3  当信号超过阈值时，CPU 中断动态修改 ADC 的阈值</p>
<p>
    使用这种方法，系统实际上将丢失一些信号准确性，因为信号可以在触发器之间的阈值范围内任意移动。然而，益处是功耗显著降低。
</p>
<p>      
    如果系统的目标是测量信号的动态值，则 PRS/DMA 驱动方法是理想的，因为它使所有数据可用，同时仍然可以提供非常有益的节能特性。
</p>        
        <h2>自主工作子系统</h2>
<p>        
    ADC示例只是众多通过睡眠模式降低应用功耗的方法之一。专注于低功耗应用的新型 MCU（如 Silicon Labs 的EFM32 Gecko MCU）拥有大量功能，可在深度睡眠模式下运行，从而实现高水平的自主行为。
</p>
<p>         
    例如，Gecko MCU 的 LESENSE（低功耗传感）模块可以自动地、周期性地采样多达 16 个通道，完全不需要 CPU 参与。它可以实现高频率检测且充电1次就能工作10年。
</p>
<p>       
    在许多情况下，单个外设可以自主地履行其职责，但也有许多需要交互的情况。在这种情况下，我们可以利用诸如在当前一些新型MCU中存在的PRS系统这样的外设互连。这些外设互连允许多个外设连接以自主执行更复杂的任务。
</p>
<p>
    图 4 显示了这样的自主系统示例，其使用事件链来执行其功能：
        <ul>
        <li>1.     RTC 以给定的时间周期性地发送 PRS 信号至 ADC 以启动转换。</li>        
        <li>2.     RTC 同时启动外部传感器，这样在测量时信号就已经准备好了。</li>
        <li>3.     ADC 完成采样并通知 DMA，DMA 把数据传送到 RAM。</li>
        <li>4.     来自 ADC 的完成 PRS 信号关闭外部传感器。</li>
        <li>5.     当缓冲器满时中断唤醒 CPU，或者超过 ADC 阈值时中断唤醒 CPU。</li>
        <li>6.     可选项：PRS 看门狗监视事件循环，确保它保持运行。</li>
    </ul>
        DMA 可以从图4所示系统中拿走，通过设置 ADC 的比较功能来做到更省电
</p>
<p><img src="/pics/blogs/run-mips-4.png"/></p>
<p>图 4  该自主 ADC 系统包含周期工作的传感器和看门狗</p>
<p>
    这些自主子系统具有以下几个主要优点：
    <ul>
    <li>1.     显著节能。</li>    
    <li>2.     即使 CPU 负载很重时传感器依旧可以稳定工作。</li>
    </ul>
    缺点是，并不是所有的 MCU 都支持这种类型的操作，并且在设置交互时，您会希望像硬件设计人员一样思考。总之，对于许多电池供电型应用来说，其优点明显多于缺点。
        
<h2>结论</h2>
</p>
<p>        
    通过利用各种节能技术，当传感器测量时，CPU几乎完全脱离工作。对于表1所示的无线应用，这将使总平均功耗从 61.6μA 降低到 37.6μA，降低了 39％，从而使电池寿命从大约 5 个月延长到 8 个月，增加了 64％，或者可以允许电池尺寸减小以改善系统外形。
</p>
<p>        
    对于非无线应用，节能将更加显著。表1中的示例，能耗将从 29.6μA 降低到 5.6 μA，由 CR2032 电池供电，理论上寿命将从 10 个月延长到 4.6 年
</p>
</body>
</html>
